ccm.component({name:"bugtrackerMwe",config:{html:[ccm.store,{local:"js/templates.json"}],remoteStore:[ccm.store,{store:"bugtracker",url:"http://ccm2.inf.h-brs.de/index.js"}],key:"demo",store:[ccm.store,"js/input.json"],style:[ccm.load,"css/bug.css"],icons:[ccm.load,"http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css"],user:[ccm.instance,"https://kaul.inf.h-brs.de/ccm/components/user2.js"]},Instance:function(){var e=this,t=0;e.render=function(r){var i=ccm.helper.element(e),o=function(t){i.html(ccm.helper.html(e.html.get("main")));var r=ccm.helper.find(e,".bugs-overview"),o=$(ccm.helper.html(e.html.get("header"),{bugIdTitle:"ID",priorityTitle:"Priority",nameTitle:"Title",statusTitle:"State",subscriberTitle:"Subscriber",descriptionTitle:"Description"}));o.appendTo(r),t=n(t);for(var s=0;t[s];){var c=$(ccm.helper.html(e.html.get("bug"),{bugId:t[s].bugId,priority:t[s].priority,subscriber:t[s].subscriber,description:t[s].description,status:t[s].state,name:t[s].name}));c.appendTo(r),s++}},s=function(){var t=i.find(".bugs-overview");t.append("<br><button class='new_bug'>Neuer Bug</button>"),t.find(".new_bug").click(function(){e.store.get(e.key,function(t){function n(e){var t=e.label||e.name;switch(delete e.label,e.input){case"select":case"textarea":e.tag=e.input;break;default:e.tag="input",e.type=e.input}if("select"===e.input){e.inner=e.options,delete e.options;for(var n=0;n<e.inner.length;n++)e.inner[n].tag="option",e.inner[n].inner=e.inner[n].caption||e.inner[n].value,delete e.inner[n].caption}delete e.input,r[0].inner.push({tag:"tr",inner:[{tag:"td",inner:t},{tag:"td",inner:e}]})}if(null===t)return e.store.set({key:e.key},function(t){e.key=t.key,i.remove(),e.render()});var r=[{tag:"table",inner:[]}];if(t.inputs)if(Array.isArray(t.inputs))for(var o=0;o<t.inputs.length;o++)n(t.inputs[o]);else n(t.inputs);if(t.fieldset&&(r={tag:"fieldset",inner:r},"string"==typeof t.fieldset&&r.inner.unshift({tag:"legend",inner:t.fieldset})),t.form&&(t.form===!0&&(t.form={button:!0}),r={tag:"form",onsubmit:t.form.onsubmit,inner:r},t.form.button)){var s={tag:"input",type:"submit",value:t.form.button};s.value===!0&&delete s.value,t.fieldset?r.inner.inner.push(s):r.inner.push(s)}i.html(ccm.helper.html(r,function(){var t=ccm.helper.formData(jQuery(this)),n=(new Date).getTime(),r={bugId:n,priority:t.priority,context:"my specific url",subscriber:t.subscriber,description:t.story,name:t.titel,state:t.status};return e.storeBug(r),e.render(),!1}))}),location.hash="newBug"})},c=function(){t=0===t?1:0,e.render()},a=function(){var t=$(this).parents(".bug").children(".bug-id").html();console.log(t),e.remoteStore.get(function(n){n.forEach(function(n){n.bugId!==t&&n.bugId.toString()!==t||e.removeBug(n)}),e.render()})},u=function(){var t=$(this).parents(".bug"),n=t.children(".bug-id").html(),r={};e.remoteStore.get(function(i){i.forEach(function(e){e.bugId!==n&&e.bugId.toString()!==n||(r=e)});var o=$(ccm.helper.html(e.html.get("bug-edit"),{bugId:r.bugId,priority:r.priority,subscriber:r.subscriber,description:r.description,name:r.name}));o.find(".fa-check").click(function(){r.state=o.find("#states").val(),r.description=o.find("#description-text").val(),e.remoteStore.set(r,function(){e.render()})}),o.find(".fa-trash").click(function(){e.render()}),t.replaceWith(o)})};e.remoteStore.get(function(e){o(e),s(),$(".current-status-header").click(this,c),$(".bug-buttons > .fa-edit").click(this,u),$(".bug-buttons > .fa-remove").click(this,a)}),r&&r()},e.storeBug=function(t){e.remoteStore.set(t,function(e){console.log(e)})},e.removeBug=function(t){t.key||console.log("Bug not persisted yet. Skip delete request."),e.remoteStore.del(t.key,function(){console.log("Delete bug with key "+t.key)})};var n=function(e){var n=[];return 0===t?(order=["open","pending","closed"],$("#status-mark").removeClass("fa-sort-up"),$("#status-mark").addClass("fa-sort-down")):(order=["closed","pending","open"],$("#status-mark").removeClass("fa-sort-down"),$("#status-mark").addClass("fa-sort-up")),order.forEach(function(t){e.forEach(function(e){e.state===t&&n.push(e)})}),n};window.onhashchange=function(){console.log(location.hash),"#newBug"!==location.hash&&e.render()}}});